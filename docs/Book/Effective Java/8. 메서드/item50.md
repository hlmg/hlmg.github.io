# Item50. 적시에 방어적 복사본을 만들라

클라이언트가 악의적인 의도를 가지고 있거나, 그런 의도가 없더라도 실수로 클래스를 오작동하게 만들 수 있으니 방어적으로 프로그래밍해야 한다.

## 생성자 방어적 복사
외부 공격으로부터 인스턴스 내부를 보호하려면 생성자에서 받은 가변 매개변수 각각을 방어적으로 복사해야 한다.

방어적 복사는 생성자 가장 처음에 수행해야한다. 검증 로직이 있다면 검증 전에 복사본을 만들어야 하는데, 그 이유는 멀티스레딩 환경에서 원복 객체의 유효성을 검사하고 복사본을 만들때 다른 스레드가 원본 객체를 수정할 위험이 있기 때문이다.

만약, 방어적 복사를 사용하는 클래스가 확장 가능한 클래스라면 clone을 사용하면 안된다. 하위 클래스의 인스턴스를 반환할 수 있고, 그 하위 클래스는 접근하면 안되는 필드 값을 클라이언트에게 전달할 수 있기 때문이다.

메서드든, 생성자든 클라이언트가 제공한 객체의 참조를 필드에 저장해야하면 다음을 생각하자.
- 넘겨받은 객체가 잠재적으로 변경될 수 있는가?
- 변경될 수 있다면 객체가 넘겨진 뒤 임의로 변경되어도 문제없이 동작하는가?

## 접근자 방어적 복사

가변 객체 필드를 가지는 클래스를 불변으로 만들어도 그 필드를 반환하게 되면 클라이언트는 얼마든지 불변 클래스를 수정할 수 있게 된다.

:::warning
Date 클래스는 값 타입이지만 가변이기 때문에 사용에 주의해야 한다. 자바 8 이후 버전이라면 Date 대신 Instant 클래스를 사용하자.
:::

이 문제를 해결하려면 접근자가 가변 필드의 방어적 복사본을 반환하면 된다. (길이가 1 이상인 배열은 무조건 가변이다.)

:::info 정리
클래스가 클라이언트로부터 받거나 클라이언트로 반환하는 객체가 가변이면 그 요소는 반드시 방어적으로 복사하자.

복사 비용이 너무 크거나 클라이언트가 잘못 수정할 일이 없음을 신뢰하면 방어적 복사를 수행하는 대신 해당 구성요소를 수정했을 때의 책임이 클라이언트에 있음을 문서에 명시하자.
:::
